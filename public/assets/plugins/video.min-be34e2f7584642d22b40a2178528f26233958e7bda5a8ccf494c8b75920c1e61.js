!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof module&&module.exports?module.exports=function(t,n){return void 0===n&&(n="undefined"!=typeof window?require("jquery"):require("jquery")(t)),e(n),n}:e(jQuery)}(function(e){"use strict";e.extend(e.FE.POPUP_TEMPLATES,{"video.insert":"[_BUTTONS_][_BY_URL_LAYER_][_EMBED_LAYER_]","video.edit":"[_BUTTONS_]","video.size":"[_BUTTONS_][_SIZE_LAYER_]"}),e.extend(e.FE.DEFAULTS,{videoInsertButtons:["videoBack","|","videoByURL","videoEmbed"],videoEditButtons:["videoDisplay","videoAlign","videoSize","videoRemove"],videoResize:!0,videoSizeButtons:["videoBack","|"],videoSplitHTML:!1,videoTextNear:!0,videoDefaultAlign:"center",videoDefaultDisplay:"block",videoMove:!0}),e.FE.VIDEO_PROVIDERS=[{test_regex:/^.*((youtu.be)|(youtube.com))\/((v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))?\??v?=?([^#\&\?]*).*/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/)?([0-9a-zA-Z_\-]+)(.+)?/g,url_text:"//www.youtube.com/embed/$1",html:'<iframe width="640" height="360" src="{url}?wmode=opaque" frameborder="0" allowfullscreen></iframe>'},{test_regex:/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:vimeo\.com)\/(?:channels\/[A-z]+\/|groups\/[A-z]+\/videos\/)?(.+)/g,url_text:"//player.vimeo.com/video/$1",html:'<iframe width="640" height="360" src="{url}" frameborder="0" allowfullscreen></iframe>'},{test_regex:/^.+(dailymotion.com|dai.ly)\/(video|hub)?\/?([^_]+)[^#]*(#video=([^_&]+))?/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:dailymotion\.com|dai\.ly)\/(?:video|hub)?\/?(.+)/g,url_text:"//www.dailymotion.com/embed/video/$1",html:'<iframe width="640" height="360" src="{url}" frameborder="0" allowfullscreen></iframe>'},{test_regex:/^.+(screen.yahoo.com)\/[^_&]+/,url_regex:"",url_text:"",html:'<iframe width="640" height="360" src="{url}?format=embed" frameborder="0" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" allowtransparency="true"></iframe>'},{test_regex:/^.+(rutube.ru)\/[^_&]+/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:rutube\.ru)\/(?:video)?\/?(.+)/g,url_text:"//rutube.ru/play/embed/$1",html:'<iframe width="640" height="360" src="{url}" frameborder="0" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" allowtransparency="true"></iframe>'}],e.FE.VIDEO_EMBED_REGEX=/^\W*((<iframe.*><\/iframe>)|(<embed.*>))\W*$/i,e.FE.PLUGINS.video=function(t){function n(){var e=t.popups.get("video.insert"),n=e.find(".fr-video-by-url-layer input");n.val("").trigger("change");var i=e.find(".fr-video-embed-layer textarea");i.val("").trigger("change")}function i(){var e=t.$tb.find('.fr-command[data-cmd="insertVideo"]'),n=t.popups.get("video.insert");if(n||(n=o()),!n.hasClass("fr-active")){t.popups.refresh("video.insert"),t.popups.setContainer("video.insert",t.$tb);var i=e.offset().left+e.outerWidth()/2,a=e.offset().top+(t.opts.toolbarBottom?10:e.outerHeight()-10);t.popups.show("video.insert",i,a,e.outerHeight())}}function a(){var n=t.popups.get("video.edit");n||(n=E()),t.popups.setContainer("video.edit",e(t.opts.scrollableContainer)),t.popups.refresh("video.edit");var i=Y.find("iframe, embed, video"),a=i.offset().left+i.outerWidth()/2,o=i.offset().top+i.outerHeight();t.popups.show("video.edit",a,o,i.outerHeight())}function o(e){if(e)return t.popups.onRefresh("video.insert",n),!0;var i="";t.opts.videoInsertButtons.length>1&&(i='<div class="fr-buttons">'+t.button.buildList(t.opts.videoInsertButtons)+"</div>");var a="";t.opts.videoInsertButtons.indexOf("videoByURL")>=0&&(a='<div class="fr-video-by-url-layer fr-layer fr-active" id="fr-video-by-url-layer-'+t.id+'"><div class="fr-input-line"><input type="text" placeholder="http://" tabIndex="1"></div><div class="fr-action-buttons"><button type="button" class="fr-command fr-submit" data-cmd="videoInsertByURL" tabIndex="2">'+t.language.translate("Insert")+"</button></div></div>");var o="";t.opts.videoInsertButtons.indexOf("videoEmbed")>=0&&(o='<div class="fr-video-embed-layer fr-layer" id="fr-video-embed-layer-'+t.id+'"><div class="fr-input-line"><textarea type="text" placeholder="'+t.language.translate("Embedded Code")+'" tabIndex="1" rows="5"></textarea></div><div class="fr-action-buttons"><button type="button" class="fr-command fr-submit" data-cmd="videoInsertEmbed" tabIndex="2">'+t.language.translate("Insert")+"</button></div></div>");var r={buttons:i,by_url_layer:a,embed_layer:o},s=t.popups.create("video.insert",r);return s}function r(e){var n,i,a=t.popups.get("video.insert");if(!Y&&!t.opts.toolbarInline){var o=t.$tb.find('.fr-command[data-cmd="insertVideo"]');n=o.offset().left+o.outerWidth()/2,i=o.offset().top+(t.opts.toolbarBottom?10:o.outerHeight()-10)}t.opts.toolbarInline&&(i=a.offset().top-t.helpers.getPX(a.css("margin-top")),a.hasClass("fr-above")&&(i+=a.outerHeight())),a.find(".fr-layer").removeClass("fr-active"),a.find(".fr-"+e+"-layer").addClass("fr-active"),t.popups.show("video.insert",n,i,0)}function s(e){var n=t.popups.get("video.insert");n.find(".fr-video-by-url-layer").hasClass("fr-active")&&e.addClass("fr-active")}function l(e){var n=t.popups.get("video.insert");n.find(".fr-video-embed-layer").hasClass("fr-active")&&e.addClass("fr-active")}function d(e){t.events.focus(!0),t.selection.restore(),t.html.insert('<span contenteditable="false" draggable="true" class="fr-jiv fr-video fr-dv'+t.opts.videoDefaultDisplay[0]+("center"!=t.opts.videoDefaultAlign?" fr-fv"+t.opts.videoDefaultAlign[0]:"")+'">'+e+"</span>",!1,t.opts.videoSplitHTML),t.popups.hide("video.insert");var n=t.$el.find(".fr-jiv");n.removeClass("fr-jiv"),n.toggleClass("fr-draggable",t.opts.videoMove),t.events.trigger("video.inserted",[n])}function c(n){if("undefined"==typeof n){var i=t.popups.get("video.insert");n=i.find('.fr-video-by-url-layer input[type="text"]').val()||""}var a=null;if(t.helpers.isURL(n))for(var o=0;o<e.FE.VIDEO_PROVIDERS.length;o++){var r=e.FE.VIDEO_PROVIDERS[o];if(r.test_regex.test(n)){a=n.replace(r.url_regex,r.url_text),a=r.html.replace(/\{url\}/,a);break}}a?d(a):t.events.trigger("video.linkError",[n])}function u(n){if("undefined"==typeof n){var i=t.popups.get("video.insert");n=i.find(".fr-video-embed-layer textarea").val()||""}0!==n.length&&e.FE.VIDEO_EMBED_REGEX.test(n)?d(n):t.events.trigger("video.codeError",[n])}function f(n){if(!t.core.sameInstance(z))return!0;n.preventDefault(),n.stopPropagation();var i=n.pageX||(n.originalEvent.touches?n.originalEvent.touches[0].pageX:null),a=n.pageY||(n.originalEvent.touches?n.originalEvent.touches[0].pageY:null);return!(!i||!a)&&(t.undo.canDo()||t.undo.saveStep(),j=e(this),j.data("start-x",i),j.data("start-y",a),B.show(),t.popups.hideAll(),void w())}function h(e){if(!t.core.sameInstance(z))return!0;if(j){e.preventDefault();var n=e.pageX||(e.originalEvent.touches?e.originalEvent.touches[0].pageX:null),i=e.pageY||(e.originalEvent.touches?e.originalEvent.touches[0].pageY:null);if(!n||!i)return!1;var a=j.data("start-x"),o=j.data("start-y");j.data("start-x",n),j.data("start-y",i);var r=n-a,s=i-o,l=Y.find("iframe, embed, video"),d=l.width(),c=l.height();(j.hasClass("fr-hnw")||j.hasClass("fr-hsw"))&&(r=0-r),(j.hasClass("fr-hnw")||j.hasClass("fr-hne"))&&(s=0-s),l.css("width",d+r),l.css("height",c+s),l.removeAttr("width"),l.removeAttr("height"),v()}}function p(e){return!t.core.sameInstance(z)||void(j&&Y&&(e&&e.stopPropagation(),j=null,B.hide(),v(),a(),t.undo.saveStep()))}function m(e){return'<div class="fr-handler fr-h'+e+'"></div>'}function g(){var n;t.shared.$video_resizer?(z=t.shared.$video_resizer,B=t.shared.$vid_overlay,t.events.on("destroy",function(){z.removeClass("fr-active").appendTo(e("body"))},!0)):(t.shared.$video_resizer=e('<div class="fr-video-resizer"></div>'),z=t.shared.$video_resizer,t.events.$on(z,"mousedown",function(e){e.stopPropagation()},!0),t.opts.videoResize&&(z.append(m("nw")+m("ne")+m("sw")+m("se")),t.shared.$vid_overlay=e('<div class="fr-video-overlay"></div>'),B=t.shared.$vid_overlay,n=z.get(0).ownerDocument,e(n).find("body").append(B))),t.events.on("shared.destroy",function(){z.html("").removeData().remove(),z=null,t.opts.videoResize&&(B.remove(),B=null)},!0),t.helpers.isMobile()||t.events.$on(e(t.o_win),"resize.video",function(){b(!0)}),t.opts.videoResize&&(n=z.get(0).ownerDocument,t.events.$on(z,t._mousedown,".fr-handler",f),t.events.$on(e(n),t._mousemove,h),t.events.$on(e(n.defaultView||n.parentWindow),t._mouseup,p),t.events.$on(B,"mouseleave",p))}function v(){z||g(),(t.$wp||e(t.opts.scrollableContainer)).append(z),z.data("instance",t);var n=Y.find("iframe, embed, video");z.css("top",(t.opts.iframe?n.offset().top-1:n.offset().top-t.$wp.offset().top-1)+t.$wp.scrollTop()).css("left",(t.opts.iframe?n.offset().left-1:n.offset().left-t.$wp.offset().left-1)+t.$wp.scrollLeft()).css("width",n.outerWidth()).css("height",n.height()).addClass("fr-active")}function y(n){if(n&&"touchend"==n.type&&U)return!0;if(n.preventDefault(),n.stopPropagation(),t.edit.isDisabled())return!1;for(var i=0;i<e.FE.INSTANCES.length;i++)e.FE.INSTANCES[i]!=t&&e.FE.INSTANCES[i].events.trigger("video.hideResizer");t.toolbar.disable(),t.helpers.isMobile()&&(t.events.disableBlur(),t.$el.blur(),t.events.enableBlur()),Y=e(this),e(this).addClass("fr-active"),t.opts.iframe&&t.size.syncIframe(),v(),a(),t.selection.clear(),t.button.bulkRefresh(),t.events.trigger("image.hideResizer")}function b(e){Y&&(k()||e===!0)&&(z.removeClass("fr-active"),t.toolbar.enable(),Y.removeClass("fr-active"),Y=null,w())}function _(){t.shared.vid_exit_flag=!0}function w(){t.shared.vid_exit_flag=!1}function k(){return t.shared.vid_exit_flag}function S(){t.events.on("mousedown window.mousedown",_),t.events.on("window.touchmove",w),t.events.on("mouseup window.mouseup",b),t.events.on("commands.mousedown",function(e){e.parents(".fr-toolbar").length>0&&b()}),t.events.on("blur video.hideResizer commands.undo commands.redo element.dropped",function(){b(!0)})}function E(){var e="";t.opts.videoEditButtons.length>=1&&(e+='<div class="fr-buttons">',e+=t.button.buildList(t.opts.videoEditButtons),e+="</div>");var n={buttons:e},i=t.popups.create("video.edit",n);return t.events.$on(t.$wp,"scroll.video-edit",function(){Y&&t.popups.isVisible("video.edit")&&a()}),i}function T(){if(Y){var e=t.popups.get("video.size"),n=Y.find("iframe, embed, video");e.find('input[name="width"]').val(n.get(0).style.width||n.attr("width")).trigger("change"),e.find('input[name="height"]').val(n.get(0).style.height||n.attr("height")).trigger("change")}}function x(){var n=t.popups.get("video.size");n||(n=C()),t.popups.refresh("video.size"),t.popups.setContainer("video.size",e(t.opts.scrollableContainer));var i=Y.find("iframe, embed, video"),a=i.offset().left+i.width()/2,o=i.offset().top+i.height();t.popups.show("video.size",a,o,i.height())}function C(e){if(e)return t.popups.onRefresh("video.size",T),!0;var n="";n='<div class="fr-buttons">'+t.button.buildList(t.opts.videoSizeButtons)+"</div>";var i="";i='<div class="fr-video-size-layer fr-layer fr-active" id="fr-video-size-layer-'+t.id+'"><div class="fr-video-group"><div class="fr-input-line"><input type="text" name="width" placeholder="'+t.language.translate("Width")+'" tabIndex="1"></div><div class="fr-input-line"><input type="text" name="height" placeholder="'+t.language.translate("Height")+'" tabIndex="1"></div></div><div class="fr-action-buttons"><button type="button" class="fr-command fr-submit" data-cmd="videoSetSize" tabIndex="2">'+t.language.translate("Update")+"</button></div></div>";var a={buttons:n,size_layer:i},o=t.popups.create("video.size",a);return t.events.$on(t.$wp,"scroll",function(){Y&&t.popups.isVisible("video.size")&&x()}),o}function M(e){Y.removeClass("fr-fvr fr-fvl"),"left"==e?Y.addClass("fr-fvl"):"right"==e&&Y.addClass("fr-fvr"),v(),a()}function L(e){return!!Y&&void(Y.hasClass("fr-fvl")?e.find("> *:first").replaceWith(t.icon.create("align-left")):Y.hasClass("fr-fvr")?e.find("> *:first").replaceWith(t.icon.create("align-right")):e.find("> *:first").replaceWith(t.icon.create("align-justify")))}function A(e,t){var n="justify";Y.hasClass("fr-fvl")?n="left":Y.hasClass("fr-fvr")&&(n="right"),t.find('.fr-command[data-param1="'+n+'"]').addClass("fr-active")}function D(e){Y.removeClass("fr-dvi fr-dvb"),"inline"==e?Y.addClass("fr-dvi"):"block"==e&&Y.addClass("fr-dvb"),v(),a()}function F(e,t){var n="block";Y.hasClass("fr-dvi")&&(n="inline"),t.find('.fr-command[data-param1="'+n+'"]').addClass("fr-active")}function N(){if(Y&&t.events.trigger("video.beforeRemove",[Y])!==!1){var e=Y;t.popups.hideAll(),b(!0),t.selection.setBefore(e.get(0))||t.selection.setAfter(e.get(0)),e.remove(),t.selection.restore(),t.html.fillEmptyBlocks(),t.events.trigger("video.removed",[e])}}function I(e){if(!e.hasClass("fr-dvi")&&!e.hasClass("fr-dvb")){var n=e.css("float");e.css("float","none"),"block"==e.css("display")?(e.css("float",n),0===parseInt(e.css("margin-left"),10)&&(e.attr("style")||"").indexOf("margin-right: auto")>=0?e.addClass("fr-fvl"):0===parseInt(e.css("margin-right"),10)&&(e.attr("style")||"").indexOf("margin-left: auto")>=0&&e.addClass("fr-fvr"),e.addClass("fr-dvb")):(e.css("float",n),"left"==e.css("float")?e.addClass("fr-fvl"):"right"==e.css("float")&&e.addClass("fr-fvr"),e.addClass("fr-dvi")),e.css("margin",""),e.css("float",""),e.css("display",""),e.css("z-index",""),e.css("position",""),e.css("overflow",""),e.css("vertical-align","")}t.opts.videoTextNear||e.removeClass("fr-dvi").addClass("fr-dvb")}function O(){t.$el.find("video").filter(function(){return 0===e(this).parents("span.fr-video").length}).wrap('<span class="fr-video" contenteditable="false"></span>'),t.$el.find("embed, iframe").filter(function(){if(t.browser.safari&&this.getAttribute("src")&&this.setAttribute("src",this.src),e(this).parents("span.fr-video").length>0)return!1;for(var n=e(this).attr("src"),i=0;i<e.FE.VIDEO_PROVIDERS.length;i++){var a=e.FE.VIDEO_PROVIDERS[i];if(a.test_regex.test(n))return!0}return!1}).map(function(){return 0===e(this).parents("object").length?this:e(this).parents("object").get(0)}).wrap('<span class="fr-video" contenteditable="false"></span>');for(var n=t.$el.find("span.fr-video"),i=0;i<n.length;i++)I(e(n[i]));n.toggleClass("fr-draggable",t.opts.videoMove)}function R(){S(),t.helpers.isMobile()&&(t.events.$on(t.$el,"touchstart","span.fr-video",function(){U=!1}),t.events.$on(t.$el,"touchmove",function(){U=!0})),t.events.on("html.set",O),O(),t.events.$on(t.$el,"mousedown","span.fr-video",function(e){e.stopPropagation()}),t.events.$on(t.$el,"click touchend","span.fr-video",y),t.events.on("keydown",function(n){var i=n.which;return!Y||i!=e.FE.KEYCODE.BACKSPACE&&i!=e.FE.KEYCODE.DELETE?Y&&i==e.FE.KEYCODE.ESC?(b(!0),n.preventDefault(),!1):Y&&!t.keys.ctrlKey(n)?(n.preventDefault(),!1):void 0:(n.preventDefault(),N(),!1)},!0),t.events.on("keydown",function(){t.$el.find("span.fr-video:empty").remove()}),o(!0),C(!0)}function $(){Y?Y.trigger("click"):(t.events.disableBlur(),t.selection.restore(),t.events.enableBlur(),t.popups.hide("video.insert"),t.toolbar.showInline())}function P(e,n){if(Y){var i=t.popups.get("video.size"),a=Y.find("iframe, embed, video");a.css("width",e||i.find('input[name="width"]').val()),a.css("height",n||i.find('input[name="height"]').val()),a.get(0).style.width&&a.removeAttr("width"),a.get(0).style.height&&a.removeAttr("height"),i.find("input").blur(),setTimeout(function(){Y.trigger("click")},t.helpers.isAndroid()?50:0)}}function H(){return Y}var B,j,z,Y,U;return t.shared.vid_exit_flag=!1,{_init:R,showInsertPopup:i,showLayer:r,refreshByURLButton:s,refreshEmbedButton:l,insertByURL:c,insertEmbed:u,insert:d,align:M,refreshAlign:L,refreshAlignOnShow:A,display:D,refreshDisplayOnShow:F,remove:N,showSizePopup:x,back:$,setSize:P,get:H}},e.FE.RegisterCommand("insertVideo",{title:"Insert Video",undo:!1,focus:!0,refreshAfterCallback:!1,popup:!0,callback:function(){this.popups.isVisible("video.insert")?(this.$el.find(".fr-marker")&&(this.events.disableBlur(),this.selection.restore()),this.popups.hide("video.insert")):this.video.showInsertPopup()},plugin:"video"}),e.FE.DefineIcon("insertVideo",{NAME:"video-camera"}),e.FE.DefineIcon("videoByURL",{NAME:"link"}),e.FE.RegisterCommand("videoByURL",{title:"By URL",undo:!1,focus:!1,callback:function(){this.video.showLayer("video-by-url")},refresh:function(e){this.video.refreshByURLButton(e)}}),e.FE.DefineIcon("videoEmbed",{NAME:"code"}),e.FE.RegisterCommand("videoEmbed",{title:"Embedded Code",undo:!1,focus:!1,callback:function(){this.video.showLayer("video-embed")},refresh:function(e){this.video.refreshEmbedButton(e)}}),e.FE.RegisterCommand("videoInsertByURL",{undo:!0,focus:!0,callback:function(){this.video.insertByURL()}}),e.FE.RegisterCommand("videoInsertEmbed",{undo:!0,focus:!0,callback:function(){this.video.insertEmbed()}}),e.FE.DefineIcon("videoDisplay",{NAME:"star"}),e.FE.RegisterCommand("videoDisplay",{title:"Display",type:"dropdown",options:{inline:"Inline",block:"Break Text"},callback:function(e,t){this.video.display(t)},refresh:function(e){this.opts.videoTextNear||e.addClass("fr-hidden")},refreshOnShow:function(e,t){this.video.refreshDisplayOnShow(e,t)}}),e.FE.DefineIcon("videoAlign",{NAME:"align-center"}),e.FE.RegisterCommand("videoAlign",{type:"dropdown",title:"Align",options:{left:"Align Left",justify:"None",right:"Align Right"},html:function(){var t='<ul class="fr-dropdown-list">',n=e.FE.COMMANDS.videoAlign.options;for(var i in n)n.hasOwnProperty(i)&&(t+='<li><a class="fr-command fr-title" data-cmd="videoAlign" data-param1="'+i+'" title="'+this.language.translate(n[i])+'">'+this.icon.create("align-"+i)+"</a></li>");return t+="</ul>"},callback:function(e,t){this.video.align(t)},refresh:function(e){this.video.refreshAlign(e)},refreshOnShow:function(e,t){this.video.refreshAlignOnShow(e,t)}}),e.FE.DefineIcon("videoRemove",{NAME:"trash"}),e.FE.RegisterCommand("videoRemove",{title:"Remove",callback:function(){this.video.remove()}}),e.FE.DefineIcon("videoSize",{NAME:"arrows-alt"}),e.FE.RegisterCommand("videoSize",{undo:!1,focus:!1,title:"Change Size",callback:function(){this.video.showSizePopup()}}),e.FE.DefineIcon("videoBack",{NAME:"arrow-left"}),e.FE.RegisterCommand("videoBack",{title:"Back",undo:!1,focus:!1,back:!0,callback:function(){this.video.back()},refresh:function(e){var t=this.video.get();t||this.opts.toolbarInline?(e.removeClass("fr-hidden"),e.next(".fr-separator").removeClass("fr-hidden")):(e.addClass("fr-hidden"),e.next(".fr-separator").addClass("fr-hidden"))}}),e.FE.RegisterCommand("videoSetSize",{undo:!0,focus:!1,callback:function(){this.video.setSize()}})});